<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MiniDBGo - API Client</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/feather-icons"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">

  <style>
    :root {
      /* YÊU CẦU 3: BẢNG MÀU LIGHT THEME CHUYÊN NGHIỆP */
      --bg-color: #F7F7F7;
      /* Nền chính (rất sáng) */
      --sidebar-bg: #FFFFFF;
      /* Sidebar */
      --card-bg: #FFFFFF;
      /* Nền thẻ */
      --border-color: #EAEAEA;
      /* Viền */
      --text-color: #242424;
      /* Chữ chính (tối) */
      --text-secondary: #6B6B6B;
      /* Chữ phụ, hướng dẫn */
      --primary-color: #0066CC;
      /* Xanh dương (điểm nhấn) */
      --primary-hover: #0056AC;
      --danger-color: #D92B2B;
      --success-color: #1A8A3D;
      --warn-color: #E58D00;
      --code-bg: #FFFFFF;
      /* Nền ô code (sáng) */
      --code-border: #DCDCDC;
    }

    * {
      box-sizing: border-box;
    }

    body {
      /* YÊU CẦU 1: SỬ DỤNG FONT OPEN SANS */
      font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      font-size: 14px;
      line-height: 1.5;
      overflow: hidden;
    }

    /* BỐ CỤC HEADER + 3 KHUNG (KHÔNG BỂ UI) */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 24px;
      height: 55px;
      /* Giảm 1 chút */
      background-color: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
    }

    .app-header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .app-layout {
      display: flex;
      height: calc(100vh - 55px);
      /* Trừ đi header */
    }

    /* 1. SIDEBAR (TRÁI) */
    .sidebar {
      width: 240px;
      flex-shrink: 0;
      background-color: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
    }

    .sidebar-body {
      padding: 16px;
      overflow-y: auto;
      flex-grow: 1;
    }

    .sidebar-body h2 {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-secondary);
      letter-spacing: 0.5px;
      margin: 0 0 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-body h2 button {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 2px;
    }

    .sidebar-body h2 button:hover {
      color: var(--primary-color);
    }

    #collection-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #collection-list li {
      padding: 8px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #collection-list li i {
      width: 16px;
      height: 16px;
      color: var(--text-secondary);
    }

    #collection-list li:hover {
      background-color: var(--bg-color);
    }

    #collection-list li.active {
      background-color: var(--primary-color);
      color: #fff;
    }

    #collection-list li.active i {
      color: #fff;
    }

    /* 2. KHUNG LÀM VIỆC CHÍNH (PHẢI) */
    .main-content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background-color: var(--bg-color);
    }

    /* 2a. KHUNG YÊU CẦU (REQUEST - TRÊN) */
    .request-panel {
      background-color: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      padding: 16px;
      display: flex;
      flex-direction: column;
    }

    /* Thanh URL và Nút Send (KHÔNG BỂ UI) */
    .request-bar {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .request-bar select {
      width: 100px;
      padding: 10px 14px;
      background-color: var(--bg-color);
      border: 1px solid var(--code-border);
      color: var(--text-color);
      border-radius: 6px;
      font-family: "SFMono-Regular", Consolas, "Courier New", Courier, monospace;
      font-size: 14px;
      font-weight: bold;
    }

    .request-bar input[type="text"] {
      flex-grow: 1;
      /* Tự co giãn */
      padding: 10px 14px;
      background-color: #FFF;
      border: 1px solid var(--code-border);
      color: var(--text-color);
      border-radius: 6px;
      font-family: "SFMono-Regular", Consolas, "Courier New", Courier, monospace;
      font-size: 14px;
    }

    .request-bar input[type="text"]:focus,
    .request-bar select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
      outline: none;
    }

    /* Nút Send */
    .request-bar button {
      padding: 10px 22px;
      background-color: var(--primary-color);
      color: #ffffff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      font-family: 'Open Sans', sans-serif;
      transition: all 0.2s ease;
      white-space: nowrap;
      /* Đảm bảo không vỡ chữ */
    }

    .request-bar button:hover {
      background-color: var(--primary-hover);
    }

    /* Tabs cho Request Body/Params */
    .sub-tabs {
      display: flex;
      margin-top: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .sub-tab-button {
      padding: 8px 14px;
      cursor: pointer;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      /* Nối liền */
    }

    .sub-tab-button.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .sub-tab-content {
      display: none;
      margin-top: 16px;
    }

    .sub-tab-content.active {
      display: block;
    }

    #request-body-content textarea {
      width: 100%;
      height: 150px;
      resize: vertical;
      background-color: var(--code-bg);
      border: 1px solid var(--code-border);
      color: var(--text-color);
      border-radius: 6px;
      font-family: "SFMono-Regular", Consolas, "Courier New", Courier, monospace;
      font-size: 14px;
      padding: 12px;
    }

    /* 2b. KHUNG PHẢN HỒI (RESPONSE - DƯỚI) */
    .response-panel {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 16px;
    }

    .response-status-bar {
      display: flex;
      gap: 20px;
      align-items: center;
      padding-bottom: 12px;
    }

    .response-status-bar span {
      font-weight: 500;
      font-size: 13px;
    }

    .response-status-bar b {
      font-weight: 600;
    }

    /* Màu cho Status */
    #response-status.success {
      color: var(--success-color);
    }

    #response-status.error {
      color: var(--danger-color);
    }

    #response-status.warn {
      color: var(--warn-color);
    }

    .response-body-wrapper {
      flex-grow: 1;
      overflow-y: auto;
      /* Chỉ cuộn ô kết quả */
      border: 1px solid var(--code-border);
      border-radius: 6px;
      background-color: var(--code-bg);
    }

    #response-headers-content {
      padding: 20px;
      white-space: pre-wrap;
      font-family: "SFMono-Regular", Consolas, "Courier New", Courier, monospace;
      color: var(--text-secondary);
    }

    /* YÊU CẦU 2: TÔ MÀU JSON KIỂU POSTMAN (LIGHT THEME) */
    /* Ghi đè toàn bộ CSS của highlight.js */
    pre code.hljs {
      padding: 20px;
      background-color: var(--code-bg);
      color: var(--text-color);
      /* Chữ mặc định */
      font-size: 14px;
      line-height: 1.7;
    }

    .hljs-attr,
    .hljs-property {
      color: #005599;
      /* Xanh đậm cho Keys */
    }

    .hljs-string {
      color: #DD4A11;
      /* Cam cho Strings */
    }

    .hljs-number {
      color: #C41A70;
      /* Tím/Hồng cho Numbers */
    }

    .hljs-literal {
      color: #0066CC;
      /* Xanh dương cho 'true', 'false', 'null' */
    }

    pre code.error {
      color: var(--danger-color);
      font-weight: bold;
      white-space: pre-wrap;
    }

    /* Nút chung (danger) */
    button.button-danger {
      padding: 8px 16px;
      background-color: var(--danger-color);
      color: #ffffff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      font-family: 'Open Sans', sans-serif;
    }
  </style>
</head>

<body>
  <header class="app-header">
    <h1>MiniDBGo Client</h1>
    <button id="btn-compact" class="button-danger">
      <i data-feather="database" style="width: 14px; height: 14px; vertical-align: -2px;"></i>
      Compact DB
    </button>
  </header>

  <div class="app-layout">

    <aside class="sidebar">
      <div class="sidebar-body">
        <h2>
          <span>Collections</span>
          <button id="btn-refresh-collections" title="Refresh Collections"><i data-feather="refresh-cw"></i></button>
        </h2>
        <ul id="collection-list">
        </ul>
      </div>
    </aside>

    <main class="main-content">

      <div class="request-panel">
        <div class="request-bar">
          <select id="rest-method">
            <option>GET</option>
            <option selected>POST</option>
            <option>PUT</option>
            <option>DELETE</option>
          </select>
          <input type="text" id="rest-path" value="/{collection}/_search">
          <button id="btn-send-rest">
            <i data-feather="send" style="width: 14px; height: 14px; vertical-align: -2px;"></i>
            Send
          </button>
        </div>

        <div class="sub-tabs" id="request-sub-tabs">
          <button class="sub-tab-button active" data-tab="request-body-content">Body</button>
          <button class="sub-tab-button" data-tab="request-params-content">Query Builder (Helper)</button>
        </div>

        <div id="request-body-content" class="sub-tab-content active">
          <textarea id="rest-body" placeholder='{&#10;  "group": "vip"&#10;}'></textarea>
        </div>

        <div id="request-params-content" class="sub-tab-content">
          <small style="color: var(--text-secondary); display: block; margin-bottom: 15px;">
            Dùng các nút trợ giúp này để tự động điền vào thanh Request ở trên.
          </small>
          <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
            <input type="text" id="helper-id" placeholder="Document ID (e.g., c1)"
              style="flex-grow: 1; background-color: #FFF; border-color: var(--code-border);">
            <button id="btn-helper-get-by-id"
              style="flex-shrink: 0; background-color: #EEE; color: #333; border: 1px solid var(--code-border); font-weight: 600;">Dùng
              "Get by ID"</button>
          </div>
          <button id="btn-helper-search"
            style="background-color: #EEE; color: #333; border: 1px solid var(--code-border); font-weight: 600;">Dùng
            "_search" (cho Collection đã chọn)</button>
        </div>
      </div>

      <div class="response-panel">
        <div class="response-status-bar">
          <span>Status: <b id="response-status">--</b></span>
          <span>Time: <b id="response-time">-- ms</b></span>
        </div>

        <div class="sub-tabs" id="response-sub-tabs">
          <button class="sub-tab-button active" data-tab="response-body-content">Body</button>
          <button class="sub-tab-button" data-tab="response-headers-content">Headers</button>
        </div>

        <div id="response-body-content" class="sub-tab-content active response-body-wrapper">
          <pre><code id="response-body-code" class="language-json">// Phản hồi API sẽ xuất hiện ở đây</code></pre>
        </div>

        <div id="response-headers-content" class="sub-tab-content" style="flex-grow: 1; overflow-y: auto;">
          // Headers phản hồi sẽ xuất hiện ở đây
        </div>
      </div>

    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
  <script>
    feather.replace(); // Kích hoạt Feather Icons
  </script>

  <script>
    // TOÀN BỘ JAVASCRIPT GIỮ NGUYÊN TỪ PHIÊN BẢN TRƯỚC
    // NÓ VẪN HOẠT ĐỘNG HOÀN HẢO VỚI BỐ CỤC MỚI
    document.addEventListener('DOMContentLoaded', () => {
      // --- Tham chiếu DOM ---
      const collectionList = document.getElementById('collection-list');
      const btnRefreshCollections = document.getElementById('btn-refresh-collections');
      const btnCompact = document.getElementById('btn-compact');

      const restMethod = document.getElementById('rest-method');
      const restPath = document.getElementById('rest-path');
      const btnSendRest = document.getElementById('btn-send-rest');

      const restBody = document.getElementById('rest-body');

      const helperIdInput = document.getElementById('helper-id');
      const btnHelperGetById = document.getElementById('btn-helper-get-by-id');
      const btnHelperSearch = document.getElementById('btn-helper-search');

      const responseStatus = document.getElementById('response-status');
      const responseTime = document.getElementById('response-time');
      const responseBodyCode = document.getElementById('response-body-code');
      const responseHeadersContent = document.getElementById('response-headers-content');

      let currentCollection = '';

      // --- Hàm Tiện ích ---
      async function apiCall(method, path, body = null, resultCodeElement = responseBodyCode) {
        resultCodeElement.textContent = 'Đang tải...';
        resultCodeElement.className = 'language-json'; // Reset
        responseStatus.textContent = '--';
        responseTime.textContent = '-- ms';
        responseStatus.className = '';

        const startTime = performance.now();

        try {
          const options = {
            method: method,
            headers: { 'Content-Type': 'application/json' },
          };

          if (body && (method === 'POST' || method === 'PUT')) {
            options.body = body;
          }

          const response = await fetch(path, options);
          const endTime = performance.now();
          const duration = (endTime - startTime).toFixed(0);

          const data = await response.json();

          responseStatus.textContent = `${response.status} ${response.statusText}`;
          responseTime.textContent = `${duration} ms`;
          if (response.status >= 200 && response.status < 300) {
            responseStatus.classList.add('success');
          } else if (response.status >= 400) {
            responseStatus.classList.add('error');
          } else {
            responseStatus.classList.add('warn');
          }

          let headersText = '';
          response.headers.forEach((value, key) => {
            headersText += `${key}: ${value}\n`;
          });
          responseHeadersContent.textContent = headersText;

          showResult(resultCodeElement, data, !response.ok);

        } catch (err) {
          const endTime = performance.now();
          const duration = (endTime - startTime).toFixed(0);

          responseStatus.textContent = `CLIENT ERROR`;
          responseStatus.classList.add('error');
          responseTime.textContent = `${duration} ms`;

          showResult(resultCodeElement, { error: err.message }, true);
        }
      }

      function showResult(codeElement, data, isError = false) {
        const jsonStr = JSON.stringify(data, null, 2);

        codeElement.textContent = jsonStr;
        codeElement.classList.remove('error');
        codeElement.classList.add('language-json');

        if (isError) {
          codeElement.classList.add('error');
        } else {
          hljs.highlightElement(codeElement);
        }
      }

      function setupSubTabs(containerId) {
        const tabContainer = document.getElementById(containerId);
        const tabButtons = tabContainer.querySelectorAll('.sub-tab-button');
        const tabContents = document.querySelectorAll(`[id^="${containerId.replace('-tabs', '')}-"]`);

        tabButtons.forEach(button => {
          button.onclick = () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            button.classList.add('active');
            document.getElementById(button.dataset.tab).classList.add('active');
          };
        });
      }

      setupSubTabs('request-sub-tabs');
      setupSubTabs('response-sub-tabs');

      // --- Logic chính ---
      async function loadCollections() {
        const response = await fetch('/_collections');
        if (!response.ok) return;
        const data = await response.json();

        collectionList.innerHTML = '';
        if (data && data.length > 0) {
          data.sort().forEach(col => {
            const li = document.createElement('li');
            li.innerHTML = `<i data-feather="database"></i> ${col}`;
            li.dataset.collectionName = col;

            li.onclick = () => {
              document.querySelectorAll('#collection-list li').forEach(item => item.classList.remove('active'));
              li.classList.add('active');
              currentCollection = col;
              restPath.value = restPath.value.replace('{collection}', currentCollection);
            };
            collectionList.appendChild(li);
          });
          feather.replace();
        } else {
          collectionList.innerHTML = `<li style="color: var(--text-secondary); cursor: default;">(No collections)</li>`;
        }
      }

      btnRefreshCollections.onclick = loadCollections;

      btnSendRest.onclick = () => {
        const method = restMethod.value;
        const path = restPath.value;
        let body = restBody.value;

        if (!path) {
          alert('Vui lòng nhập đường dẫn (Path)');
          return;
        }

        if (method === 'GET' || method === 'DELETE') {
          body = null;
        } else if (!body) {
          body = '{}';
        }

        apiCall(method, path, body, responseBodyCode);
      };

      btnCompact.onclick = () => {
        if (confirm('Bạn có chắc muốn chạy nén (compaction) cơ sở dữ liệu không?')) {
          restMethod.value = 'POST';
          restPath.value = '/_compact';
          restBody.value = '';
          apiCall('POST', '/_compact', null, responseBodyCode);
        }
      };

      // --- Logic các Nút Trợ giúp ---
      btnHelperGetById.onclick = () => {
        if (!currentCollection) {
          alert("Vui lòng chọn một Collection từ sidebar trước.");
          return;
        }
        const id = helperIdInput.value;
        if (!id) {
          alert("Vui lòng nhập một ID vào ô 'Document ID'.");
          return;
        }
        restMethod.value = 'GET';
        restPath.value = `/${currentCollection}/${id}`;
        restBody.value = '';
        document.querySelector('.sub-tab-button[data-tab="request-body-content"]').click();
        btnSendRest.focus();
      };

      btnHelperSearch.onclick = () => {
        if (!currentCollection) {
          alert("Vui lòng chọn một Collection từ sidebar trước.");
          return;
        }
        restMethod.value = 'POST';
        restPath.value = `/${currentCollection}/_search`;
        document.querySelector('.sub-tab-button[data-tab="request-body-content"]').click();
        restBody.focus();
      };

      // Khởi động
      loadCollections();
    });
  </script>
</body>

</html>