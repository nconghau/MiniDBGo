<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MiniDBGo - API Client</title>

  <!-- 1. Tải TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 2. Tải Feather Icons -->
  <script src="https://unpkg.com/feather-icons"></script>

  <!-- 3. Tải Highlight.js (cho tô màu JSON) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">

  <!-- 4. CSS Tuỳ chỉnh (Quan trọng) -->
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    /* === YÊU CẦU 2: TÔ MÀU JSON (FIX v3.1) === */
    /* Tăng tối đa độ đặc hiệu (specificity) bằng cách dùng ID.
       Điều này đảm bảo các quy tắc bên dưới sẽ THẮNG file github.min.css
    */
    pre code#response-body-code.hljs {
      padding: 1.25rem;
      background-color: #FFFFFF !important;
      color: #242424 !important;
      font-size: 14px;
      line-height: 1.7;
    }

    pre code#response-body-code.hljs .hljs-attr,
    pre code#response-body-code.hljs .hljs-property {
      color: #9b239b !important;
      /* Postman: Tím hồng */
    }

    pre code#response-body-code.hljs .hljs-string {
      color: #DD4A11 !important;
      /* Postman: Cam */
    }

    pre code#response-body-code.hljs .hljs-number {
      color: #C41A70 !important;
      /* Postman: Đỏ hồng */
    }

    pre code#response-body-code.hljs .hljs-literal {
      color: #0066CC !important;
      /* Postman: Xanh dương */
    }

    /* === KẾT THÚC FIX TÔ MÀU === */


    pre code.error {
      color: #D92B2B;
      /* Đỏ */
      font-weight: bold;
      white-space: pre-wrap;
    }

    .method-btn[data-method="GET"] {
      color: #008a00;
      font-weight: 600;
    }

    .method-btn[data-method="POST"] {
      color: #0066cc;
      font-weight: 600;
    }

    .method-btn[data-method="PUT"] {
      color: #e58d00;
      font-weight: 600;
    }

    .method-btn[data-method="DELETE"] {
      color: #d92b2b;
      font-weight: 600;
    }

    .sub-tab-button.active {
      color: #2563EB;
      border-bottom-color: #2563EB;
    }

    #collection-list li.active {
      background-color: #EFF6FF;
      color: #2563EB;
      font-weight: 600;
    }

    #collection-list li.active i {
      color: #2563EB;
    }
  </style>
</head>

<body class="flex flex-col h-screen bg-gray-100 font-sans text-gray-900 overflow-hidden">

  <!-- Lớp phủ cho Sidebar Mobile -->
  <div id="sidebar-overlay" class="md:hidden fixed inset-0 bg-black/50 z-30 hidden"></div>

  <!-- Header -->
  <header class="flex-shrink-0 bg-white border-b border-gray-200">
    <div class="h-16 flex items-center justify-between px-4 max-w-full mx-auto">
      <div class="flex items-center gap-4">
        <button id="btn-toggle-sidebar" class="md:hidden p-1 text-gray-600 hover:text-gray-900">
          <i data-feather="menu" class="w-6 h-6"></i>
        </button>
        <h1 class="text-xl font-bold text-gray-800">MiniDBGo Client</h1>
      </div>
      <button id="btn-compact"
        class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors">
        <i data-feather="database" class="w-4 h-4"></i>
        Compact DB
      </button>
    </div>
  </header>

  <!-- Bố cục chính (3 cột) -->
  <div class="flex-1 flex overflow-hidden max-w-full mx-auto w-full">

    <!-- CỘT 1 - COLLECTIONS -->
    <aside id="sidebar"
      class="flex-shrink-0 fixed md:static inset-y-0 left-0 z-40 flex flex-col w-64 bg-gray-50 border-r border-gray-200 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
      <div class="flex-shrink-0 h-16 flex items-center justify-between p-4 border-b border-gray-200">
        <h2 class="text-sm font-semibold uppercase text-gray-500 tracking-wider">Collections</h2>
        <button id="btn-refresh-collections" title="Refresh Collections"
          class="p-1 text-gray-500 hover:text-blue-600 rounded-full hover:bg-gray-200">
          <i data-feather="refresh-cw" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-2">
        <ul id="collection-list">
          <!-- JS chèn collections -->
        </ul>
      </div>
    </aside>

    <!-- Bố cục 2 cột còn lại -->
    <main class="flex-1 flex flex-row overflow-hidden p-4 gap-4">

      <!-- CỘT 2 - REQUEST -->
      <div id="request-panel"
        class="flex-1 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden flex flex-col">

        <!-- Thanh Request (URL Bar) -->
        <div class="flex-shrink-0 flex gap-2 p-4 border-b border-gray-200 relative">

          <div>
            <button id="method-toggle-button" data-method="POST"
              class="method-btn w-28 text-left px-4 py-2 text-sm font-bold bg-gray-100 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 flex items-center justify-between">
              <span>POST</span>
              <i data-feather="chevron-down" class="w-4 h-4"></i>
            </button>
            <div id="method-dropdown"
              class="hidden absolute z-10 w-28 mt-1 bg-white border border-gray-300 rounded-md shadow-lg">
              <a href="#" class="method-option block px-4 py-2 text-sm" data-method="GET">
                <span class="method-btn" data-method="GET">GET</span>
              </a>
              <a href="#" class="method-option block px-4 py-2 text-sm" data-method="POST">
                <span class="method-btn" data-method="POST">POST</span>
              </a>
              <a href="#" class="method-option block px-4 py-2 text-sm" data-method="PUT">
                <span class="method-btn" data-method="PUT">PUT</span>
              </a>
              <a href="#" class="method-option block px-4 py-2 text-sm" data-method="DELETE">
                <span class="method-btn" data-method="DELETE">DELETE</span>
              </a>
            </div>
          </div>

          <input type="text" id="rest-path" value="/{collection}/_search" list="collection-suggestions"
            class="flex-1 min-w-0 px-4 py-2 text-sm font-mono bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="/{collection}/{id}">
          <datalist id="collection-suggestions">
            <!-- JS chèn các <option> vào đây -->
          </datalist>

          <button id="btn-send-rest"
            class="flex-shrink-0 flex items-center justify-center gap-2 px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">
            <i data-feather="send" class="w-4 h-4"></i>
            Send
          </button>
        </div>

        <!-- Tabs cho Request Body/Helpers -->
        <div id="request-sub-tabs" class="flex-shrink-0 flex border-b border-gray-200 px-4">
          <button
            class="sub-tab-button active py-3 px-4 text-sm font-medium text-gray-500 border-b-2 border-transparent -mb-px"
            data-tab="request-body-content">Body</button>
          <button
            class="sub-tab-button py-3 px-4 text-sm font-medium text-gray-500 border-b-2 border-transparent -mb-px"
            data-tab="request-params-content">Query Helpers</button>
        </div>

        <!-- Nội dung Tab Request (Cuộn) -->
        <div class="flex-1 overflow-y-auto p-4">
          <div id="request-body-content" class="sub-tab-content active">
            <textarea id="rest-body" placeholder='{&#10;  "group": "vip"&#10;}'
              class="w-full h-40 p-3 text-sm font-mono bg-gray-50 border border-gray-300 rounded-md resize-vertical focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>
          <div id="request-params-content" class="sub-tab-content hidden">
            <p class="text-sm text-gray-600 mb-4">
              Sử dụng các nút trợ giúp này để tự động điền vào thanh Request ở trên (yêu cầu chọn Collection trước).
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="font-semibold text-gray-800 mb-3">Thao tác theo ID</h3>
                <input type="text" id="helper-id" placeholder="Document ID (e.g., c1)"
                  class="w-full px-3 py-2 text-sm font-mono bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <div class="flex gap-2 mt-3">
                  <button id="btn-helper-get-by-id"
                    class="flex-1 px-3 py-2 text-sm font-medium text-green-700 bg-green-100 rounded-md hover:bg-green-200">
                    GET
                  </button>
                  <button id="btn-helper-update-by-id"
                    class="flex-1 px-3 py-2 text-sm font-medium text-yellow-700 bg-yellow-100 rounded-md hover:bg-yellow-200">
                    PUT
                  </button>
                  <button id="btn-helper-delete-by-id"
                    class="flex-1 px-3 py-2 text-sm font-medium text-red-700 bg-red-100 rounded-md hover:bg-red-200">
                    DELETE
                  </button>
                </div>
              </div>
              <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="font-semibold text-gray-800 mb-3">Thao tác hàng loạt</h3>
                <p class="text-xs text-gray-500 mb-3">
                  Sử dụng các API `_search` hoặc `_insertMany` cho Collection đã chọn.
                </p>
                <div class="flex gap-2 mt-3">
                  <button id="btn-helper-search"
                    class="flex-1 px-3 py-2 text-sm font-medium text-blue-700 bg-blue-100 rounded-md hover:bg-blue-200">
                    _search
                  </button>
                  <button id="btn-helper-insert-many"
                    class="flex-1 px-3 py-2 text-sm font-medium text-purple-700 bg-purple-100 rounded-md hover:bg-purple-200">
                    _insertMany
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CỘT 3 - RESPONSE -->
      <div id="response-panel"
        class="flex-1 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden flex flex-col">

        <!-- Thanh Status Response -->
        <div class="flex-shrink-0 flex items-center gap-6 p-4 bg-gray-50 border-b border-gray-200">
          <span class="text-sm">Status: <b id="response-status" class="font-bold">--</b></span>
          <span class="text-sm">Time: <b id="response-time" class="font-bold">-- ms</b></span>
        </div>

        <!-- Tabs cho Response Body/Headers -->
        <div id="response-sub-tabs" class="flex-shrink-0 flex border-b border-gray-200 px-4">
          <button
            class="sub-tab-button active py-3 px-4 text-sm font-medium text-gray-500 border-b-2 border-transparent -mb-px"
            data-tab="response-body-content">Body</button>
          <button
            class="sub-tab-button py-3 px-4 text-sm font-medium text-gray-500 border-b-2 border-transparent -mb-px"
            data-tab="response-headers-content">Headers</button>
        </div>

        <!-- Nội dung Tab Response (Cuộn) -->
        <div class="flex-1 overflow-auto">
          <div id="response-body-content" class="sub-tab-content active h-full">
            <!-- ID `response-body-code` được CSS sử dụng để tô màu -->
            <pre
              class="h-full"><code id="response-body-code" class="language-json h-full">// Phản hồi API sẽ xuất hiện ở đây</code></pre>
          </div>
          <div id="response-headers-content"
            class="sub-tab-content hidden h-full overflow-auto p-5 font-mono text-sm text-gray-700 whitespace-pre-wrap">
            // Headers phản hồi sẽ xuất hiện ở đây
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- 5. Tải Highlight.js (JS) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>

  <!-- 6. JavaScript của Ứng dụng -->
  <script>
    feather.replace(); // Kích hoạt Feather Icons

    document.addEventListener('DOMContentLoaded', () => {
      // --- Tham chiếu DOM ---
      const collectionList = document.getElementById('collection-list');
      const collectionSuggestions = document.getElementById('collection-suggestions');
      const btnRefreshCollections = document.getElementById('btn-refresh-collections');
      const btnCompact = document.getElementById('btn-compact');

      const methodToggleButton = document.getElementById('method-toggle-button');
      const methodDropdown = document.getElementById('method-dropdown');
      const methodOptions = document.querySelectorAll('.method-option');

      const restPath = document.getElementById('rest-path');
      const btnSendRest = document.getElementById('btn-send-rest');
      const restBody = document.getElementById('rest-body');

      const helperIdInput = document.getElementById('helper-id');
      const btnHelperGetById = document.getElementById('btn-helper-get-by-id');
      const btnHelperSearch = document.getElementById('btn-helper-search');
      const btnHelperUpdateById = document.getElementById('btn-helper-update-by-id');
      const btnHelperDeleteById = document.getElementById('btn-helper-delete-by-id');
      const btnHelperInsertMany = document.getElementById('btn-helper-insert-many');

      const responseStatus = document.getElementById('response-status');
      const responseTime = document.getElementById('response-time');
      const responseBodyCode = document.getElementById('response-body-code');
      const responseHeadersContent = document.getElementById('response-headers-content');

      const btnToggleSidebar = document.getElementById('btn-toggle-sidebar');
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebar-overlay');

      let currentCollection = '';
      let currentMethod = 'POST'; // Mặc định

      // --- Hàm Tiện ích ---
      async function apiCall(method, path, body = null, resultCodeElement = responseBodyCode) {
        resultCodeElement.textContent = 'Đang tải...';

        // === FIX LỖI JS (v3.1) ===
        // Dòng `resultCodeElement.className = 'language-json';` cũ đã bị xoá
        // vì nó làm mất class `h-full` và `hljs`
        // Giờ chúng ta chỉ cần đảm bảo class `language-json` và `h-full` có ở đó
        resultCodeElement.className = 'language-json h-full';
        // === KẾT THÚC FIX ===

        responseStatus.textContent = '--';
        responseTime.textContent = '-- ms';
        responseStatus.className = 'font-bold';

        const startTime = performance.now();

        try {
          const options = {
            method: method,
            headers: { 'Content-Type': 'application/json' },
          };

          if (body && (method === 'POST' || method === 'PUT')) {
            options.body = body;
          }

          const response = await fetch(path, options);
          const endTime = performance.now();
          const duration = (endTime - startTime).toFixed(0);

          let data;
          try {
            data = await response.json();
          } catch (e) {
            data = { error: "Phản hồi không phải là JSON hợp lệ." };
          }

          responseStatus.textContent = `${response.status} ${response.statusText}`;
          responseTime.textContent = `${duration} ms`;
          if (response.status >= 200 && response.status < 300) {
            responseStatus.classList.add('text-green-600');
          } else if (response.status >= 400) {
            responseStatus.classList.add('text-red-600');
          } else {
            responseStatus.classList.add('text-yellow-600');
          }

          let headersText = '';
          response.headers.forEach((value, key) => {
            headersText += `${key}: ${value}\n`;
          });
          responseHeadersContent.textContent = headersText;

          showResult(resultCodeElement, data, !response.ok);

        } catch (err) {
          const endTime = performance.now();
          const duration = (endTime - startTime).toFixed(0);
          responseStatus.textContent = `CLIENT ERROR`;
          responseStatus.classList.add('text-red-600');
          responseTime.textContent = `${duration} ms`;
          showResult(resultCodeElement, { error: err.message }, true);
        }
      }

      function showResult(codeElement, data, isError = false) {
        const jsonStr = JSON.stringify(data, null, 2);
        codeElement.textContent = jsonStr;

        // Xoá class 'error' cũ (nếu có)
        codeElement.classList.remove('error');
        // Vẫn giữ 'language-json' và 'h-full'
        codeElement.className = 'language-json h-full';

        if (isError) {
          codeElement.classList.add('error');
        } else {
          // Chỉ gọi highlightElement khi không lỗi
          // Nó sẽ tự động thêm class 'hljs' và các <span> tô màu
          hljs.highlightElement(codeElement);
        }
      }

      function setupSubTabs(containerId) {
        const tabContainer = document.getElementById(containerId);
        const tabButtons = Array.from(tabContainer.children).filter(el => el.classList.contains('sub-tab-button'));
        const contentPrefix = containerId.replace('-tabs', '');
        const tabContents = document.querySelectorAll(`[id^="${contentPrefix}-"]`);

        tabButtons.forEach(button => {
          button.onclick = () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.add('hidden'));
            button.classList.add('active');
            const contentToShow = document.getElementById(button.dataset.tab);
            if (contentToShow) {
              contentToShow.classList.remove('hidden');
            }
          };
        });
      }

      setupSubTabs('request-sub-tabs');
      setupSubTabs('response-sub-tabs');

      // --- Logic Responsive ---
      function toggleSidebar() {
        sidebar.classList.toggle('-translate-x-full');
        sidebarOverlay.classList.toggle('hidden');
      }
      btnToggleSidebar.onclick = toggleSidebar;
      sidebarOverlay.onclick = toggleSidebar;

      // --- LOGIC MỚI: HTTP METHOD DROPDOWN ---
      function setMethod(method) {
        currentMethod = method;
        methodToggleButton.dataset.method = method;
        methodToggleButton.querySelector('span').textContent = method;
        methodToggleButton.classList.remove('text-green-600', 'text-blue-600', 'text-yellow-600', 'text-red-600');

        if (method === 'GET') methodToggleButton.classList.add('text-green-600');
        else if (method === 'POST') methodToggleButton.classList.add('text-blue-600');
        else if (method === 'PUT') methodToggleButton.classList.add('text-yellow-600');
        else if (method === 'DELETE') methodToggleButton.classList.add('text-red-600');

        methodDropdown.classList.add('hidden');
      }

      setMethod(currentMethod);

      methodToggleButton.onclick = (e) => {
        e.stopPropagation();
        methodDropdown.classList.toggle('hidden');
      };

      methodOptions.forEach(option => {
        option.onclick = (e) => {
          e.preventDefault();
          setMethod(e.currentTarget.dataset.method);
        };
      });

      window.onclick = () => {
        if (!methodDropdown.classList.contains('hidden')) {
          methodDropdown.classList.add('hidden');
        }
      };

      // --- Logic chính ---
      async function loadCollections() {
        const response = await fetch('/_collections');
        if (!response.ok) {
          collectionList.innerHTML = `<li class="p-3 text-sm text-red-600">(Lỗi tải collections)</li>`;
          return;
        }
        const data = await response.json();

        collectionList.innerHTML = '';
        collectionSuggestions.innerHTML = '';

        if (data && data.length > 0) {
          data.sort().forEach(col => {
            const li = document.createElement('li');
            li.className = "flex items-center gap-3 p-3 text-sm text-gray-700 hover:bg-gray-200 cursor-pointer rounded-md";
            li.innerHTML = `<i data-feather="database" class="w-4 h-4 text-gray-500"></i> <span class="flex-1 truncate">${col}</span>`;
            li.dataset.collectionName = col;
            li.onclick = () => {
              document.querySelectorAll('#collection-list li').forEach(item => item.classList.remove('active'));
              li.classList.add('active');
              currentCollection = col;
              restPath.value = restPath.value.replace(/^{collection}/, currentCollection);
              if (window.innerWidth < 768) {
                toggleSidebar();
              }
            };
            collectionList.appendChild(li);

            const option = document.createElement('option');
            option.value = col;
            collectionSuggestions.appendChild(option);
          });
          feather.replace();
        } else {
          collectionList.innerHTML = `<li class="p-3 text-sm text-gray-500 italic">(No collections)</li>`;
        }
      }

      btnRefreshCollections.onclick = loadCollections;

      btnSendRest.onclick = () => {
        const method = currentMethod;
        const path = restPath.value;
        let body = restBody.value;

        if (!path || path === "/{collection}/_search" || path.startsWith('/{collection}')) {
          alert('Vui lòng chọn một Collection từ sidebar trước.');
          return;
        }

        if (method === 'GET' || method === 'DELETE') {
          body = null;
        } else if (!body) {
          body = '{}';
        }

        document.querySelector('#response-sub-tabs .sub-tab-button[data-tab="response-body-content"]').click();
        apiCall(method, path, body, responseBodyCode);
      };

      btnCompact.onclick = () => {
        if (confirm('Bạn có chắc muốn chạy nén (compaction) cơ sở dữ liệu không?')) {
          setMethod('POST');
          restPath.value = '/_compact';
          restBody.value = '';
          document.querySelector('#response-sub-tabs .sub-tab-button[data-tab="response-body-content"]').click();
          apiCall('POST', '/_compact', null, responseBodyCode);
        }
      };

      // --- Logic các Nút Trợ giúp ---
      function checkCollection() {
        if (!currentCollection) {
          alert("Vui lòng chọn một Collection từ sidebar trước.");
          return false;
        }
        return true;
      }
      function checkId() {
        const id = helperIdInput.value;
        if (!id) {
          alert("Vui lòng nhập một ID vào ô 'Document ID'.");
          return null;
        }
        return id;
      }
      function switchToBodyTab() {
        document.querySelector('#request-sub-tabs .sub-tab-button[data-tab="request-body-content"]').click();
      }

      btnHelperGetById.onclick = () => {
        if (!checkCollection()) return;
        const id = checkId();
        if (!id) return;

        setMethod('GET');
        restPath.value = `/${currentCollection}/${id}`;
        restBody.value = '';
        switchToBodyTab();
        btnSendRest.focus();
      };

      btnHelperUpdateById.onclick = () => {
        if (!checkCollection()) return;
        const id = checkId();
        if (!id) return;

        setMethod('PUT');
        restPath.value = `/${currentCollection}/${id}`;
        restBody.value = `{\n  "_id": "${id}",\n  "key": "value" \n}`;
        switchToBodyTab();
        restBody.focus();
      };

      btnHelperDeleteById.onclick = () => {
        if (!checkCollection()) return;
        const id = checkId();
        if (!id) return;

        if (!confirm(`Bạn có chắc muốn XÓA tài liệu '${id}' từ collection '${currentCollection}' không?`)) {
          return;
        }

        setMethod('DELETE');
        restPath.value = `/${currentCollection}/${id}`;
        restBody.value = '';
        switchToBodyTab();
        btnSendRest.click();
      };

      btnHelperSearch.onclick = () => {
        if (!checkCollection()) return;
        setMethod('POST');
        restPath.value = `/${currentCollection}/_search`;
        restBody.value = `{\n  "group": "vip"\n}`;
        switchToBodyTab();
        restBody.focus();
      };

      btnHelperInsertMany.onclick = () => {
        if (!checkCollection()) return;
        setMethod('POST');
        restPath.value = `/${currentCollection}/_insertMany`;
        restBody.value = `[\n  {\n    "_id": "doc1",\n    "data": "value1"\n  },\n  {\n    "_id": "doc2",\n    "data": "value2"\n  }\n]`;
        switchToBodyTab();
        restBody.focus();
      };

      // Khởi động
      loadCollections();
    });
  </script>
</body>

</html>